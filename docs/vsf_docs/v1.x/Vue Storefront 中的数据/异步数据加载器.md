# å¼‚æ­¥æ•°æ®åŠ è½½å™¨

ä» Vue Storefront 1.8 å¼€å§‹ï¼Œæœ‰ä¸€ä¸ªæ–°çš„å®éªŒæ€§ API ç”¨äºæ‰©å±•æœåŠ¡å™¨ç«¯æ•°æ®è·å–ã€‚è¯¥åº“è¢«è°ƒç”¨`AsyncDataLoader`å¹¶ç”±ä¸¤ä¸ªæ–¹æ³•ç»„æˆï¼š`push`ï¼Œç”¨äºå°†æ–°çš„æ•°æ®è·å–æ‰¿è¯ºæ’å…¥`flush`é˜Ÿåˆ—ï¼Œä»¥åŠï¼Œç”¨äºæ‰§è¡Œæ‰€æœ‰æ’å…¥é˜Ÿåˆ—çš„æ‰¿è¯ºã€‚

Vue Storefront çš„æœåŠ¡ç«¯æ¸²æŸ“åŠŸèƒ½æ˜¯æŒ‰ç…§ä¸€èˆ¬çš„[Vue.js SSR åŸåˆ™è®¾è®¡çš„ ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰](https://vuejs.org/v2/guide/ssr.html). æ¯ä¸ªæ ¹çº§é¡µé¢ï¼ˆåˆ†é…ç»™ä¸€ä¸ªè·¯ç”±ï¼‰éƒ½åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„`asyncData`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨åˆ›å»ºä»»ä½•ç»„ä»¶ä¹‹å‰æ‰§è¡Œï¼Œåªæ˜¯ä¸ºäº†ç”¨æ‰€æœ‰å¿…è¦çš„æ•°æ®å¡«å…… Vuex çŠ¶æ€ã€‚

ç„¶ååœ¨`window.__INITIAL_STATE__`å¯¹è±¡å†…å°†é¢„å–çš„ Vuex çŠ¶æ€æä¾›ç»™å®¢æˆ·ç«¯ä»¥å¯¹å®¢æˆ·ç«¯æ•°æ®è¿›è¡Œæ°´åˆã€‚

å› ä¸º`asyncData`æ–¹æ³•æ˜¯é›†ä¸­å¼çš„ï¼ˆæ¯ä¸ªè·¯ç”±ä¸€ä¸ªï¼‰ï¼Œæ‰€ä»¥ä¸å¯èƒ½ä»æ·»åŠ åˆ° Vue Storefront çš„ä¸»é¢˜çš„ä»»ä½•æ¨¡å—/è‡ªå®šä¹‰ä»£ç ä¸­æ³¨å…¥ä»»ä½•æ•°æ®é¢„å–æ–¹æ³•ã€‚å¦‚æœæ‚¨åœ¨ä¸»é¢˜ä¸­åˆ›å»ºäº†è‡ªå·±çš„ç‰ˆæœ¬`Product.vue`æˆ–`Category.vue`é¡µé¢ï¼Œæ‚¨å¯èƒ½å·²ç»æ›´æ”¹ï¼Œ`asyncData`ä½†ä»…æ­¤è€Œå·²ã€‚

æ‰€ä»¥æˆ‘ä»¬æœ‰äº† AsyncLoader ğŸ˜ƒ

## [#](https://docs.vuestorefront.io/v1/guide/data/data-loader.html#examples)ä¾‹å­

çœ‹`src/module-template/hooks/beforeRegistration`ä¸€ä¸ªä¾‹å­ï¼š

```js
import { AsyncDataLoader } from '@vue-storefront/core/lib/async-data-loader'
  AsyncDataLoader.push({ // this is an example showing how to call data loader from another module
    execute: ({ route, store, context }) => {
      return new Promise ((resolve, reject) => {
        store.dispatch('example/dataloader').then((results) => {
          resolve(results)
        })
      })
    }
  })
```

å°±è¿™æ ·ï¼æ­¤å¤„æ’é˜Ÿçš„æ“ä½œå°†éšæ¯ä¸ª SSR è¯·æ±‚æ‰§è¡Œï¼Œ`store.state.exampleDataFetchedByLoader`å¹¶å°†é™„åŠ åˆ° ï¼Œ`window.__INITIAL_STATE__.exampleDataFetchedByLoader`ä»¥ä¾¿æ‚¨çš„æ•°æ®å¯ä»¥åœ¨ SSR æ¨¡å¼ä¸‹è®¿é—®ã€‚

æ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥æä¾›çš„`route`æˆ–`context`å¯¹è±¡æ¥æœ‰é€‰æ‹©åœ°æ‰§è¡Œè·å–é€»è¾‘ï¼š

```js
import { AsyncDataLoader } from '@vue-storefront/core/lib/async-data-loader'
  AsyncDataLoader.push({ // this is an example showing how to call data loader from another module
    execute: ({ route, store, context }) => {
      return new Promise ((resolve, reject) => {
        if (route.name === 'bundle-product') {
          store.dispatch('example/dataloader').then((results) => {
            resolve(results)
          })
        } else {
          resolve(null)
        }
      })
    }
  })
```

è¯¥`context`å¯¹è±¡æ˜¯`Vue.prototype.$ssrContext`ï¼Œå®ƒç­‰äº`context`å¯¹è±¡ä¼ é€’ç»™`asyncData`æ–¹æ³•ï¼š

```js
    const context = {
      url: req.url,
      output: {
        prepend: (context) => { return '' }, // these functions can be replaced in the Vue components to append or prepend some content AFTER all other things are rendered. So in this function You may call: output.prepend() { return context.renderStyles() } to attach styles
        append: (context) => { return '' },
        appendHead: (context) => { return '' },
        template: 'default',
        cacheTags: null
      },
      server: {
        app: app,
        response: res,
        request: req
      },
      meta: null,
      vs: {
        config: config,
        storeCode: req.header('x-vs-store-code') ? req.header('x-vs-store-code') : process.env.STORE_CODE
      }
    }
```

æ­£å¦‚æ‚¨å¯èƒ½åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çœ‹åˆ°çš„ï¼Œæ‚¨çš„æ¨¡å—å¯ä»¥è®¿é—®`Express.js`app (thru `context.server`)ï¼