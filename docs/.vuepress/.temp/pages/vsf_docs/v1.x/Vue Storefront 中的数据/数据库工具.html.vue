<template><h1 id="数据库工具" tabindex="-1"><a class="header-anchor" href="#数据库工具" aria-hidden="true">#</a> 数据库工具</h1>
<p>Vue Storefront 从<a href="https://github.com/vuestorefront/vue-storefront-api" target="_blank" rel="noopener noreferrer">vue-storefront-api<OutboundLink/></a>获取所有数据<a href="https://github.com/vuestorefront/vue-storefront-api" target="_blank" rel="noopener noreferrer"> （打开新窗口）<OutboundLink/></a>端点，在 Elasticsearch 数据存储之上运行。</p>
<p>如果你用<code>yarn installer</code> 命令安装了项目，数据库已经建立，从demo-dump中导入数据，一切都应该没问题。</p>
<p>在更广泛的数据操作之后，比如使用<a href="https://github.com/vuestorefront/mage2vuestorefront" target="_blank" rel="noopener noreferrer">mage2vuestorefront<OutboundLink/></a>自定义导入<a href="https://github.com/vuestorefront/mage2vuestorefront" target="_blank" rel="noopener noreferrer"> （打开新窗口）<OutboundLink/></a>或<a href="https://github.com/divanteLtd/magento1-vsbridge" target="_blank" rel="noopener noreferrer">magento1-vsbridge （打开新窗口）<OutboundLink/></a>，需要重新索引 Elasticsearch 并为字段设置适当的元数据。</p>
<p>您知道必须重新索引数据库的主要原因是您从<code>vue-storefront</code>控制台收到以下错误：</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code>Error<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"root_cause"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"illegal_argument_exception"</span><span class="token punctuation">,</span><span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"Fielddata is disabled on text fields by default. Set fielddata=true on [created_at] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"search_phase_execution_exception"</span><span class="token punctuation">,</span><span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"all shards failed"</span><span class="token punctuation">,</span><span class="token property">"phase"</span><span class="token operator">:</span><span class="token string">"query"</span><span class="token punctuation">,</span><span class="token property">"grouped"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">"failed_shards"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"shard"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token string">"vue_storefront_catalog_1521776807"</span><span class="token punctuation">,</span><span class="token property">"node"</span><span class="token operator">:</span><span class="token string">"xIOeZW2lTwaprGXh6YLyCA"</span><span class="token punctuation">,</span><span class="token property">"reason"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"illegal_argument_exception"</span><span class="token punctuation">,</span><span class="token property">"reason"</span><span class="token operator">:</span><span class="token string">"Fielddata is disabled on text fields by default. Set fielddata=true on [created_at] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>在这种情况下，本地<code>vue-storefront-api</code>安装中有一个 db 工具可以进行救援。</p>
<h2 id="重新索引现有数据库" tabindex="-1"><a class="header-anchor" href="#重新索引现有数据库" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/data/database-tool.html#re-indexing-an-existing-database" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>重新索引现有数据库</h2>
<p>请转到<code>vue-storefront-api</code>目录并运行：</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> db rebuild
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>此命令将：</p>
<ul>
<li>将您当前设置的（在<code>config/local.json</code>配置文件中）Elasticsearch 索引重新索引为 temp-one。</li>
<li>将正确的 Elasticsearch 映射放在临时索引之上。</li>
<li>删除原始索引。</li>
<li>使用原始名称创建临时名称的别名，以便您可以使用原始名称而无需任何引用更改。</li>
</ul>
<p>您可以<code>config/local.json</code>通过运行指定不同的（与 中设置的不同）索引名称：</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> db rebuild -- --indexName<span class="token operator">=</span>custom_index_name
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="创建新索引" tabindex="-1"><a class="header-anchor" href="#创建新索引" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/data/database-tool.html#creating-the-new-index" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>创建新索引</h2>
<p>如果要创建新的空索引，请运行：</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> db new
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>此工具将删除您当前的索引并创建一个新的空索引，其中包含所有元字段集。</p>
<p>您可以<code>config/local.json</code>通过运行指定不同的（与 中设置的不同）索引名称：</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> db rebuild -- --indexName<span class="token operator">=</span>custom_index_name
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="更改索引结构-添加新字段-更改类型" tabindex="-1"><a class="header-anchor" href="#更改索引结构-添加新字段-更改类型" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/data/database-tool.html#changing-the-index-structure-adding-new-fields-changing-the-types" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>更改索引结构/添加新字段/更改类型</h2>
<p>如果您想扩展 Elasticsearch 数据结构或映射某些特定的字段类型，例如，在遇到此类错误后：</p>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>[{"type":"illegal_argument_exception","reason":"Fielddata is disabled on text fields by default. Set fielddata=true on [created_at] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."}]
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>请通过修改来更改 ES 架构：</p>
<ul>
<li><a href="https://github.com/vuestorefront/vue-storefront-api/blob/master/config/elastic.schema.product.extension.json" target="_blank" rel="noopener noreferrer">配置/elastic.schema.product.extension.json（打开新窗口）<OutboundLink/></a></li>
<li><a href="https://github.com/vuestorefront/vue-storefront-api/blob/master/config/elastic.schema.attribute.extension.json" target="_blank" rel="noopener noreferrer">配置/elastic.schema.attribute.extension.json（打开新窗口）<OutboundLink/></a></li>
<li><a href="https://github.com/vuestorefront/vue-storefront-api/blob/master/config/elastic.schema.taxrate.extension.json" target="_blank" rel="noopener noreferrer">配置/elastic.schema.taxrate.extension.json（打开新窗口）<OutboundLink/></a></li>
</ul>
<p>格式符合<a href="https://www.elastic.co/blog/found-elasticsearch-mapping-introduction" target="_blank" rel="noopener noreferrer">ES DSL 的模式修改（打开新窗口）<OutboundLink/></a></p>
<p>更改后，运行以下索引命令：</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> db rebuild
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></template>
