<template><h1 id="å¼‚æ­¥æ•°æ®åŠ è½½å™¨" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥æ•°æ®åŠ è½½å™¨" aria-hidden="true">#</a> å¼‚æ­¥æ•°æ®åŠ è½½å™¨</h1>
<p>ä» Vue Storefront 1.8 å¼€å§‹ï¼Œæœ‰ä¸€ä¸ªæ–°çš„å®éªŒæ€§ API ç”¨äºæ‰©å±•æœåŠ¡å™¨ç«¯æ•°æ®è·å–ã€‚è¯¥åº“è¢«è°ƒç”¨<code>AsyncDataLoader</code>å¹¶ç”±ä¸¤ä¸ªæ–¹æ³•ç»„æˆï¼š<code>push</code>ï¼Œç”¨äºå°†æ–°çš„æ•°æ®è·å–æ‰¿è¯ºæ’å…¥<code>flush</code>é˜Ÿåˆ—ï¼Œä»¥åŠï¼Œç”¨äºæ‰§è¡Œæ‰€æœ‰æ’å…¥é˜Ÿåˆ—çš„æ‰¿è¯ºã€‚</p>
<p>Vue Storefront çš„æœåŠ¡ç«¯æ¸²æŸ“åŠŸèƒ½æ˜¯æŒ‰ç…§ä¸€èˆ¬çš„<a href="https://vuejs.org/v2/guide/ssr.html" target="_blank" rel="noopener noreferrer">Vue.js SSR åŸåˆ™è®¾è®¡çš„ ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a>. æ¯ä¸ªæ ¹çº§é¡µé¢ï¼ˆåˆ†é…ç»™ä¸€ä¸ªè·¯ç”±ï¼‰éƒ½åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„<code>asyncData</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨åˆ›å»ºä»»ä½•ç»„ä»¶ä¹‹å‰æ‰§è¡Œï¼Œåªæ˜¯ä¸ºäº†ç”¨æ‰€æœ‰å¿…è¦çš„æ•°æ®å¡«å…… Vuex çŠ¶æ€ã€‚</p>
<p>ç„¶ååœ¨<code>window.__INITIAL_STATE__</code>å¯¹è±¡å†…å°†é¢„å–çš„ Vuex çŠ¶æ€æä¾›ç»™å®¢æˆ·ç«¯ä»¥å¯¹å®¢æˆ·ç«¯æ•°æ®è¿›è¡Œæ°´åˆã€‚</p>
<p>å› ä¸º<code>asyncData</code>æ–¹æ³•æ˜¯é›†ä¸­å¼çš„ï¼ˆæ¯ä¸ªè·¯ç”±ä¸€ä¸ªï¼‰ï¼Œæ‰€ä»¥ä¸å¯èƒ½ä»æ·»åŠ åˆ° Vue Storefront çš„ä¸»é¢˜çš„ä»»ä½•æ¨¡å—/è‡ªå®šä¹‰ä»£ç ä¸­æ³¨å…¥ä»»ä½•æ•°æ®é¢„å–æ–¹æ³•ã€‚å¦‚æœæ‚¨åœ¨ä¸»é¢˜ä¸­åˆ›å»ºäº†è‡ªå·±çš„ç‰ˆæœ¬<code>Product.vue</code>æˆ–<code>Category.vue</code>é¡µé¢ï¼Œæ‚¨å¯èƒ½å·²ç»æ›´æ”¹ï¼Œ<code>asyncData</code>ä½†ä»…æ­¤è€Œå·²ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬æœ‰äº† AsyncLoader ğŸ˜ƒ</p>
<h2 id="ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#ä¾‹å­" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/data/data-loader.html#examples" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>ä¾‹å­</h2>
<p>çœ‹<code>src/module-template/hooks/beforeRegistration</code>ä¸€ä¸ªä¾‹å­ï¼š</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AsyncDataLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue-storefront/core/lib/async-data-loader'</span>
  AsyncDataLoader<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// this is an example showing how to call data loader from another module</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> route<span class="token punctuation">,</span> store<span class="token punctuation">,</span> context <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'example/dataloader'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>å°±è¿™æ ·ï¼æ­¤å¤„æ’é˜Ÿçš„æ“ä½œå°†éšæ¯ä¸ª SSR è¯·æ±‚æ‰§è¡Œï¼Œ<code>store.state.exampleDataFetchedByLoader</code>å¹¶å°†é™„åŠ åˆ° ï¼Œ<code>window.__INITIAL_STATE__.exampleDataFetchedByLoader</code>ä»¥ä¾¿æ‚¨çš„æ•°æ®å¯ä»¥åœ¨ SSR æ¨¡å¼ä¸‹è®¿é—®ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥æä¾›çš„<code>route</code>æˆ–<code>context</code>å¯¹è±¡æ¥æœ‰é€‰æ‹©åœ°æ‰§è¡Œè·å–é€»è¾‘ï¼š</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AsyncDataLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue-storefront/core/lib/async-data-loader'</span>
  AsyncDataLoader<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// this is an example showing how to call data loader from another module</span>
    <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> route<span class="token punctuation">,</span> store<span class="token punctuation">,</span> context <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'bundle-product'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'example/dataloader'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è¯¥<code>context</code>å¯¹è±¡æ˜¯<code>Vue.prototype.$ssrContext</code>ï¼Œå®ƒç­‰äº<code>context</code>å¯¹è±¡ä¼ é€’ç»™<code>asyncData</code>æ–¹æ³•ï¼š</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code>    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token operator">:</span> req<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      output<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">prepend</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// these functions can be replaced in the Vue components to append or prepend some content AFTER all other things are rendered. So in this function You may call: output.prepend() { return context.renderStyles() } to attach styles</span>
        <span class="token function-variable function">append</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">appendHead</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        template<span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
        cacheTags<span class="token operator">:</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      server<span class="token operator">:</span> <span class="token punctuation">{</span>
        app<span class="token operator">:</span> app<span class="token punctuation">,</span>
        response<span class="token operator">:</span> res<span class="token punctuation">,</span>
        request<span class="token operator">:</span> req
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      vs<span class="token operator">:</span> <span class="token punctuation">{</span>
        config<span class="token operator">:</span> config<span class="token punctuation">,</span>
        storeCode<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'x-vs-store-code'</span><span class="token punctuation">)</span> <span class="token operator">?</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'x-vs-store-code'</span><span class="token punctuation">)</span> <span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">STORE_CODE</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>æ­£å¦‚æ‚¨å¯èƒ½åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çœ‹åˆ°çš„ï¼Œæ‚¨çš„æ¨¡å—å¯ä»¥è®¿é—®<code>Express.js</code>app (thru <code>context.server</code>)ï¼</p>
</template>
