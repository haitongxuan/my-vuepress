<template><h1 id="ch-2-vsf-ä¸Šä¸‹æ–‡ä¸­çš„-elasticsearch" tabindex="-1"><a class="header-anchor" href="#ch-2-vsf-ä¸Šä¸‹æ–‡ä¸­çš„-elasticsearch" aria-hidden="true">#</a> Ch 2. VSF ä¸Šä¸‹æ–‡ä¸­çš„ Elasticsearch</h1>
<h1 id="ç¬¬-2-ç« -vsf-ä¸Šä¸‹æ–‡ä¸­çš„-elasticsearch" tabindex="-1"><a class="header-anchor" href="#ç¬¬-2-ç« -vsf-ä¸Šä¸‹æ–‡ä¸­çš„-elasticsearch" aria-hidden="true">#</a> ç¬¬ 2 ç«  VSF ä¸Šä¸‹æ–‡ä¸­çš„ Elasticsearch</h1>
<p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ï¼š</p>
<ul>
<li><a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_0-introduction" target="_blank" rel="noopener noreferrer">0. ä»‹ç»<OutboundLink/></a></li>
<li><a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_1-now-es7-is-also-supported-in-vsf" target="_blank" rel="noopener noreferrer">1.ç°åœ¨VSFä¹Ÿæ”¯æŒES7äº†<OutboundLink/></a></li>
<li><a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_2-extend-elasticsearch-entities-for-vsf" target="_blank" rel="noopener noreferrer">2. ä¸º VSF æ‰©å±• Elasticsearch å®ä½“<OutboundLink/></a></li>
</ul>
<h2 id="_0-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_0-ä»‹ç»" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_0-introduction" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>0. ä»‹ç»</h2>
<p><em>Elasticsearch</em>æ˜¯<em>Vue Storefront</em>ä¸ºå…¶æ•°æ®å­˜å‚¨çš„é€‰æ‹©ï¼Œè¿™å¾ˆè‡ªç„¶ï¼Œè¿™èƒŒåä¸€å®šæœ‰åŸå› ã€‚é¡¾åæ€ä¹‰ï¼Œ<em>Elastic</em>æ„å‘³ç€å¯æ‰©å±•ã€å¯æ‰©å±•ã€åˆ†å¸ƒå¼å’Œç±»å‹ä¸å¯çŸ¥ï¼Œè¿™åœ¨å¤§æ•°æ®æ—¶ä»£éå¸¸æ£’ï¼Œè€Œ<em>æœç´¢</em>æ„å‘³ç€ç´¢å¼•ã€è¿‡æ»¤ã€åœ¨<em>CRUD</em>ä¸­<em>è¯»å–</em>ï¼Œè¿™æ˜¾ç¤ºäº†å®ƒçš„é‡ç‚¹ã€‚åˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆï¼ŒElasticsearch æœ‰ä»€ä¹ˆå¥½å¤§æƒŠå°æ€ªçš„å‘¢ï¼Ÿ</p>
<p><em>Elasticsearch</em>æ˜¯ä¸€ä¸ªåŸºäº<em>Apache Lucene</em>å®šä¹‰çš„å…¨æ–‡æœç´¢å’Œåˆ†æå¼•æ“ã€‚å®ƒé‡‡ç”¨å€’æ’ç´¢å¼•ï¼Œè¿™æ„å‘³ç€<em>æ–‡æ¡£</em>é€šè¿‡æ‰€æœ‰å‡ºç°çš„å”¯ä¸€<em>æœ¯è¯­</em>è¿›è¡Œç´¢å¼•ï¼Œå¹¶ä¸”åˆ©ç”¨ç»„è£…æ¯ä¸ªå­—æ®µæ•°æ®ç»“æ„çš„èƒ½åŠ›å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆ<em>Elasticsearch</em>æ˜¯è¶…å¿«çš„ã€‚</p>
<p>å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®ƒæ˜¯å¤©ç”Ÿçš„åˆ†å¸ƒå¼ã€‚æ¥è‡ªå•ä¸ªèŠ‚ç‚¹ elasticsearch å’Œå®ƒçš„å¤šä¸ªé›†ç¾¤çš„ç»éªŒå‡ ä¹ç›¸åŒï¼Œå¹¶ä¸”è¿™æ ·åšæ˜¯æ— ç—›çš„ï¼Œå› ä¸ºå®ƒå¼€ç®±å³ç”¨ã€‚å‡ ä¹æœ‰å¾ˆå¤šè§‚ç‚¹å¯ä»¥è¯´æ˜ä¸ºä»€ä¹ˆ<em>Elasticsearch</em>æ˜¯æ‚¨é€‰æ‹©çš„æ•°æ®ä¸­å¿ƒå’Œåº—é¢ä¹‹é—´çš„ä¸­é—´ç«™ã€‚ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­è®¨è®ºå®ƒæ˜¯å¦‚ä½•åœ¨<em>Vue Storefront ä¸­</em>å®ç°çš„ã€‚</p>
<p><em>Vue Storefront</em>ä¸ºè‡ªå·±å®šä¹‰äº†ä¸åç«¯æ— å…³çš„ PWA ç”µå­å•†åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­<em>Vue Storefront</em>æ˜¯é¡¾åæ€ä¹‰çš„åº—é¢ï¼Œè€Œ<em>Elasticsearch</em>ç”¨ä½œ<em>ç›®å½•</em>åŠå…¶å…„å¼Ÿæ•°æ®ï¼ˆå¦‚<em>taxrule</em>ã€<em>äº§å“</em>ç­‰ï¼‰çš„æ•°æ®å­˜å‚¨ã€‚å½“åº—é¢è¯·æ±‚æœ‰å…³äº§å“çš„ä¿¡æ¯æ—¶ï¼Œå®ƒä¼šè·å–æœ‰å…³ä»<em>Elasticsearch</em>æŸ¥è¯¢çš„<em>æœ¯è¯­</em>çš„<em>æ–‡æ¡£**ç´¢å¼•</em>ï¼Œè€Œæ— éœ€å°†å…¶éå†åˆ°æº Web å•†åº—ï¼ˆæ— è®ºæ˜¯ Magentoï¼‰ï¼Œå› æ­¤å®ƒä¼šè·³è¿‡å…¶æ•°æ®åº“åé¢çš„å•†åº—çš„æ‰€æœ‰ç¹é‡è´Ÿè½½è®©å®¢æˆ·æ»¡æ„çš„æ„‰å¿«ä½“éªŒã€‚</p>
<p>é—²è¯å°‘è¯´ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä»€ä¹ˆæ˜¯å¼€èƒƒèœğŸ˜ƒ</p>
<h2 id="_1-ç°åœ¨vsfä¹Ÿæ”¯æŒes7äº†" tabindex="-1"><a class="header-anchor" href="#_1-ç°åœ¨vsfä¹Ÿæ”¯æŒes7äº†" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_1-now-es7-is-also-supported-in-vsf" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>1.ç°åœ¨VSFä¹Ÿæ”¯æŒES7äº†</h2>
<p><em>Elasticsearch</em>ä¸€ç›´åœ¨å¤§è§„æ¨¡å‡çº§ï¼Œé—´éš”å¦‚æ­¤ä¹‹å¤§ï¼Œåœ¨<code>6.7</code>å’Œ<code>7.0</code>. ä½ èƒ½æ„Ÿå—åˆ°ç¤¾åŒºçš„çƒ­åº¦å—ï¼Ÿè™½ç„¶æˆ‘ä»¬å¯ä»¥äº«å—<em>Elastic Stack</em>çš„æ”¹è¿›å’Œå¢å¼ºï¼Œä½†åœ¨å¹³æ»‘å‡çº§ä¹‹å‰æœ‰ä¸€ä¸ªåˆ—è¡¨éœ€è¦æ£€æŸ¥ã€‚è€Œä¸”å®ƒçš„å·¥ä½œæ–¹å¼ä¸æ‚¨éœ€è¦ä¿®å¤<em>Vue Storefront</em>å †æ ˆä»¥ä¸<em>Elasticsearch 7.x</em>å…¼å®¹çš„æ–¹å¼ç›¸åŒã€‚</p>
<p>ç”±äº<em>Vue Storefront</em>å †æ ˆä¸»è¦é€šè¿‡<em>Vue Storefront API</em>ä¸<em>Elasticsearch</em>ç›¸å…³è”ï¼Œå› æ­¤æ‚¨åº”è¯¥ä¿®å¤<em>Vue Storefront API çš„</em>æ–‡ä»¶ä»¥åŠæ¥è‡ª<em>Vue Storefront</em>çš„ä¸€äº›è°ƒç”¨è€…ã€‚ä½†æ˜¯ï¼Œå¤§å¤šæ•°æ›´æ”¹éƒ½æ˜¯æœ‰æ„åœ¨å¹³å°çš„æ ¸å¿ƒéƒ¨åˆ†è¿›è¡Œçš„ï¼Œå› æ­¤æ‚¨çš„åŠ³åŠ¨å°†è¢«æœ€å°åŒ–ï¼Œä»¥å®ç°å†…å¿ƒçš„å¹³é™ã€‚å°½ç®¡å¦‚æ­¤ï¼Œ<em>é…ç½®</em>å’Œ/æˆ–<em>è¿ç§»</em>éœ€è¦åœ¨å¿…è¦æ—¶è¿›è¡Œä¿®å¤ã€‚è¿™ä¸ªé£Ÿè°±ä¼šä¸€æ­¥ä¸€æ­¥åœ°æ•™ä½ å¦‚ä½•åšã€‚</p>
<h3 id="_1-å‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_1-å‡†å¤‡" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_1-preparation" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>1. å‡†å¤‡</h3>
<ul>
<li>æ‚¨éœ€è¦<a href="https://docs.vuestorefront.io/v1/guide/cookbook/setup" target="_blank" rel="noopener noreferrer">è®¾ç½®<em>Vue Storefront</em>å †æ ˆï¼Œ<OutboundLink/></a>åŒ…æ‹¬<em>Vue Storefront API</em>ã€‚</li>
<li><em>Vue Storefront</em>ç‰ˆæœ¬<code>1.11</code>åŠæ›´é«˜ç‰ˆæœ¬æ”¯æŒ ES7 ã€‚ä½ åº”è¯¥ç›¸åº”åœ°æ‹¥æœ‰å®ƒã€‚</li>
<li><em>Vue Storefront API</em>ç‰ˆæœ¬<code>1.11</code>åŠæ›´é«˜ç‰ˆæœ¬æ”¯æŒ ES7 ã€‚ä½ ä¹Ÿåº”è¯¥ç›¸åº”åœ°æ‹¥æœ‰å®ƒã€‚</li>
<li>ES7 ç”±<em>mage2vuestorefront</em>å’Œ branchæ”¯æŒ<code>feature/es7</code>ã€‚ä½ ä¹Ÿåº”è¯¥æ‹¥æœ‰å®ƒã€‚</li>
</ul>
<p>ç¬”è®°</p>
<p>å¦‚ä½•ä¸‹è½½æœ€æ–°çš„<code>1.11</code>é€šè¿‡<code>git</code>ä¸­è§£é‡Š<a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#secret-1-how-to-upgrade-to-1-11-technically-foolproof-approach" target="_blank" rel="noopener noreferrer"><em>æ™®ç½—è’‚æ™®</em><OutboundLink/></a></p>
<h3 id="_2-é£Ÿè°±" tabindex="-1"><a class="header-anchor" href="#_2-é£Ÿè°±" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_2-recipe" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>2. é£Ÿè°±</h3>
<ol>
<li>æ‚¨åº”è¯¥ä¿®å¤<code>docker-compose.nodejs.yml</code>æ–‡ä»¶ï¼Œå› ä¸ºé“¾æ¥çš„<em>Elasticsearch</em>å®¹å™¨åº”è¯¥æ›´æ–°å¦‚ä¸‹ï¼š</li>
</ol>
<p>docker-compose.nodejs.ymlæ”¹å˜</p>
<table>
<thead>
<tr>
<th></th>
<th>@@ -6,7 +6,7 @@ æœåŠ¡ï¼š</th>
</tr>
</thead>
<tbody>
<tr>
<td>66</td>
<td>è¯­å¢ƒï¼š ã€‚</td>
</tr>
<tr>
<td>77</td>
<td>dockerfile: docker/vue-storefront-api/Dockerfile</td>
</tr>
<tr>
<td>88</td>
<td>å–å†³äºï¼š</td>
</tr>
<tr>
<td>9</td>
<td>-       -<s>es1</s></td>
</tr>
<tr>
<td>9</td>
<td>+       -es7</td>
</tr>
<tr>
<td>1010</td>
<td>- Redis</td>
</tr>
<tr>
<td>1111</td>
<td>env_file: docker/vue-storefront-api/default.env</td>
</tr>
<tr>
<td>1212</td>
<td>ç¯å¢ƒï¼š</td>
</tr>
</tbody>
</table>
<ol>
<li><code>docker-compose</code>å¯¹äº<em>Elasticsearch 7</em>è¢«åŒ…å«åœ¨<code>1.11</code>ã€‚è®©æˆ‘ä»¬ä»<strong>Vue Storefront API æ ¹è·¯å¾„</strong>è¿è¡Œ<em>Elasticsearch 7</em>çš„ docker å®¹å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>docker-compose -f docker-compose.elastic7.yml -f docker-compose.nodejs.yml up
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>æç¤º</p>
<p>æ‚¨å¯ä»¥åœ¨<em>åˆ†ç¦»</em>æ¨¡å¼ä¸‹ä½¿ç”¨é€‰é¡¹æ ‡å¿—è¿è¡Œå®ƒï¼Œ<code>-d</code>å¦‚</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>docker-compose -f docker-compose.elastic7.yml -f docker-compose.nodejs.yml up -d
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol>
<li>æ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å±å¹•ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>Starting es7 <span class="token punctuation">..</span>. 
Starting vuestorefrontapi_redis_1 <span class="token punctuation">..</span>. 
Starting vuestorefrontapi_redis_1
Starting vuestorefrontapi_redis_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Attaching to es7, vuestorefrontapi_redis_1
es7      <span class="token operator">|</span> OpenJDK <span class="token number">64</span>-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated <span class="token keyword">in</span> version <span class="token number">9.0</span> and will likely be removed <span class="token keyword">in</span> a future release.
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:C <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.554 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:C <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.554 <span class="token comment"># Redis version=4.0.14, bits=64, commit=00000000, modified=0, pid=1, just started</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:C <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.554 <span class="token comment"># Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.555 * Running <span class="token assign-left variable">mode</span><span class="token operator">=</span>standalone, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">6379</span>.
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.555 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.555 <span class="token comment"># Server initialized</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.556 <span class="token comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.556 <span class="token comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span>
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.556 * DB loaded from disk: <span class="token number">0.000</span> seconds
redis_1  <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">23</span> Dec <span class="token number">18</span>:00:28.556 * Ready to accept connections
es7      <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"server"</span>, <span class="token string">"timestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2019-12-23T18:00:30,129+0000"</span>, <span class="token string">"level"</span><span class="token builtin class-name">:</span> <span class="token string">"INFO"</span>, <span class="token string">"component"</span><span class="token builtin class-name">:</span> <span class="token string">"o.e.e.NodeEnvironment"</span>, <span class="token string">"cluster.name"</span><span class="token builtin class-name">:</span> <span class="token string">"docker-cluster"</span>, <span class="token string">"node.name"</span><span class="token builtin class-name">:</span> <span class="token string">"be374d24f82e"</span>,  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"using [1] data paths, mounts [[/ (overlay)]], net usable_space [149.4gb], net total_space [250.9gb], types [overlay]"</span>  <span class="token punctuation">}</span>
es7      <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"server"</span>, <span class="token string">"timestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2019-12-23T18:00:30,133+0000"</span>, <span class="token string">"level"</span><span class="token builtin class-name">:</span> <span class="token string">"INFO"</span>, <span class="token string">"component"</span><span class="token builtin class-name">:</span> <span class="token string">"o.e.e.NodeEnvironment"</span>, <span class="token string">"cluster.name"</span><span class="token builtin class-name">:</span> <span class="token string">"docker-cluster"</span>, <span class="token string">"node.name"</span><span class="token builtin class-name">:</span> <span class="token string">"be374d24f82e"</span>,  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"heap size [494.9mb], compressed ordinary object pointers [true]"</span>  <span class="token punctuation">}</span>
es7      <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"server"</span>, <span class="token string">"timestamp"</span><span class="token builtin class-name">:</span> <span class="token string">"2019-12-23T18:00:30,135+0000"</span>, <span class="token string">"level"</span><span class="token builtin class-name">:</span> <span class="token string">"INFO"</span>, <span class="token string">"component"</span><span class="token builtin class-name">:</span> <span class="token string">"o.e.n.Node"</span>, <span class="token string">"cluster.name"</span><span class="token builtin class-name">:</span> <span class="token string">"docker-cluster"</span>, <span class="token string">"node.name"</span><span class="token builtin class-name">:</span> <span class="token string">"be374d24f82e"</span>,  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"node name [be374d24f82e], node ID [e8P_hrouSEKIWnylBaelVw], cluster name [docker-cluster]"</span>  <span class="token punctuation">}</span>
<span class="token comment"># abridged ...</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>ğŸ“¼ä½ ä¹Ÿå¯ä»¥åœ¨<a href="https://asciinema.org/a/NcfdFuMkJ5LWzVbgb7m35coOV" target="_blank" rel="noopener noreferrer">bashæ’­æ”¾ä¸­<OutboundLink/></a>è§‚çœ‹<a href="https://asciinema.org/a/NcfdFuMkJ5LWzVbgb7m35coOV" target="_blank" rel="noopener noreferrer">ğŸ¥ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></p>
<p>æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°è¯¥è„šæœ¬ç”Ÿæˆäº†ä¸¤ä¸ªå®¹å™¨ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨äº for<code>redis</code>è€Œå¦ä¸€ä¸ªç”¨äº<code>elasticsearch 7</code>ã€‚ï¼ˆ<code>kibana</code>å®¹å™¨æ˜¯å¯é€‰çš„<code>1.11</code>ï¼‰</p>
<ol>
<li><code>localhost:9200</code>ä»æ‚¨çš„æµè§ˆå™¨è®¿é—®ç„¶åå®ƒåº”è¯¥æ‰“å°å¦‚ä¸‹ï¼š</li>
</ol>
<div class="language-text ext-text line-numbers-mode"><pre v-pre class="language-text"><code>{
  "name" : "be374d24f82e",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "3Gk6anHkQU--5TmenJkdrw",
  "version" : {
    "number" : "7.3.2",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "1c1faf1",
    "build_date" : "2019-09-06T14:40:30.409026Z",
    "build_snapshot" : false,
    "lucene_version" : "8.1.0",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol>
<li>ä¿®å¤<code>local.json</code>åˆ°ç”¨äºæ›´æ–°é…ç½®<code>indexTypes</code>å’Œ<code>apiVersion</code>ä¸‹<code>elasticsearch</code>å¦‚ä¸‹ï¼š</li>
</ol>
<p>é…ç½®/æœ¬åœ°.jsonæ”¹å˜</p>
<table>
<thead>
<tr>
<th></th>
<th>@@ -2,8 +2,6 @@</th>
</tr>
</thead>
<tbody>
<tr>
<td>22</td>
<td>â€œä¸»æœºâ€ï¼šâ€œæœ¬åœ°ä¸»æœºâ€ï¼Œ</td>
</tr>
<tr>
<td>33</td>
<td>â€œç«¯å£â€ï¼š9200ï¼Œ</td>
</tr>
<tr>
<td>44</td>
<td>&quot;åè®®&quot;: &quot;http&quot;,</td>
</tr>
<tr>
<td>5</td>
<td>-     â€œç”¨æˆ·â€ï¼šâ€œå¼¹æ€§â€ï¼Œ</td>
</tr>
<tr>
<td>6</td>
<td>-     &quot;å¯†ç &quot;: &quot;changeme&quot;,</td>
</tr>
<tr>
<td>75</td>
<td>â€œmin_scoreâ€ï¼š0.01ï¼Œ</td>
</tr>
<tr>
<td>86</td>
<td>â€œæŒ‡æ•°â€ï¼š[</td>
</tr>
<tr>
<td>97</td>
<td>&quot;vue_storefront_catalog&quot;,</td>
</tr>
<tr>
<td></td>
<td>@@ -13,10 +11,11 @@</td>
</tr>
<tr>
<td>1311</td>
<td>â€œç´¢å¼•ç±»å‹â€ï¼š[</td>
</tr>
<tr>
<td>1412</td>
<td>â€œäº§å“â€ï¼Œ</td>
</tr>
<tr>
<td>1513</td>
<td>â€œç±»åˆ«â€ï¼Œ</td>
</tr>
<tr>
<td>16</td>
<td>â€”â€”       â€<s>å˜ç±³</s>â€ï¼Œ</td>
</tr>
<tr>
<td>14</td>
<td>+       &quot;cms_blockâ€ï¼Œ</td>
</tr>
<tr>
<td>15</td>
<td>+       &quot;cms_page&quot;,</td>
</tr>
<tr>
<td>1716</td>
<td>â€œå±æ€§â€ï¼Œ</td>
</tr>
<tr>
<td>1817</td>
<td>&quot;ç¨æ³•&quot;,</td>
</tr>
<tr>
<td>1918</td>
<td>â€œå®¡æŸ¥â€</td>
</tr>
<tr>
<td>2019</td>
<td>],</td>
</tr>
<tr>
<td>21</td>
<td>-     &quot;apiVersion&quot;: &quot;<s>5</s>.<s>6</s>â€</td>
</tr>
<tr>
<td>22</td>
<td>-   },</td>
</tr>
<tr>
<td>20</td>
<td>+     &quot;apiVersion&quot;: &quot;7.1â€</td>
</tr>
<tr>
<td>21</td>
<td>+   },</td>
</tr>
</tbody>
</table>
<ol>
<li>ä¸€æ—¦<em>Elasticsearch 7</em>å®ä¾‹å¯åŠ¨å¹¶è¿è¡Œï¼Œç„¶åè¿è¡Œæ–°è„šæœ¬ï¼Œè¯¥è„šæœ¬ä½¿ç”¨åº”ç”¨çš„æ­£ç¡®æ•°æ®ç±»å‹çš„å­—æ®µåˆ›å»ºç´¢å¼•ã€‚</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> db7 new
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>è¿™æ˜¯å› ä¸ºæ‚¨åº”è¯¥æ–°æ”¾ç½®<em>Elasticsearch 7 çš„</em>æ˜ å°„ï¼Œå®ƒåªå…è®¸æ¯ä¸ª<em>ç´¢å¼•</em>ä¸€ä¸ª<em>æ–‡æ¡£</em>ã€‚<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html" target="_blank" rel="noopener noreferrer">æ›´å¤šä¿¡æ¯<OutboundLink/></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html" target="_blank" rel="noopener noreferrer">ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></p>
<p>å±å¹•åå‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">yarn</span> run v1.21.1
$ node scripts/db7.js new
** Hello<span class="token operator">!</span> I am going to create NEW ES index
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Public index <span class="token builtin class-name">alias</span> does not exists aliases_not_found_exception
Done <span class="token keyword">in</span> <span class="token number">2</span>.27s.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ğŸ“¼ä½ ä¹Ÿå¯ä»¥åœ¨<a href="https://asciinema.org/a/UErONnmqK1m2EFNkWRrG0E6p4" target="_blank" rel="noopener noreferrer">bashæ’­æ”¾ä¸­<OutboundLink/></a>è§‚çœ‹<a href="https://asciinema.org/a/UErONnmqK1m2EFNkWRrG0E6p4" target="_blank" rel="noopener noreferrer">ğŸ¥ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></p>
<p>åˆ«æ‹…å¿ƒ<code>aliases_not_found_exception</code>ã€‚è¿™åªæ˜¯æ„å‘³ç€å®ƒæœªèƒ½æ¸…é™¤å­¤ç«‹çš„åˆ«åï¼Œå› ä¸ºé¦–å…ˆæ²¡æœ‰è¦åˆ é™¤çš„åˆ«åã€‚</p>
<ol>
<li>ä»ç»ˆç«¯é’ˆå¯¹ Elasticsearch API æ£€æŸ¥æ˜ å°„æ˜¯å¦å·²æˆåŠŸåˆ›å»ºï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> -XGET <span class="token string">'http://localhost:9200/_mapping?pretty=true'</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>ç»“æœåº”æ˜¾ç¤ºä¸ºï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">"vue_storefront_catalog_cms_block"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"creation_time"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"date"</span>,
          <span class="token string">"format"</span> <span class="token builtin class-name">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"id"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"long"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"identifier"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"update_time"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"date"</span>,
          <span class="token string">"format"</span> <span class="token builtin class-name">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"vue_storefront_catalog_review"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"vue_storefront_catalog_taxrule"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"id"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"long"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"rates"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">"rate"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"float"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,

<span class="token comment"># ... abridged ...</span>

  <span class="token string">"vue_storefront_catalog_category"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"mappings"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"properties"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">"created_at"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"date"</span>,
          <span class="token string">"format"</span> <span class="token builtin class-name">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"is_active"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"boolean"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"parent_id"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"position"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"product_count"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"slug"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"updated_at"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"date"</span>,
          <span class="token string">"format"</span> <span class="token builtin class-name">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"url_key"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"url_path"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>ä½ ä¼šå‘ç°æ¯ä¸ªç´¢å¼•åªæœ‰å®ƒçš„ä¸€ä¸ªå¸¦æœ‰çº¦å®šçš„æ˜ å°„<code>${indexName}_${entityType}</code>ã€‚</p>
<ol>
<li>ä¸‹ä¸€æ­¥æ˜¯å°†æ•°æ®ä»æº Web å•†åº—æŠ½å–åˆ°æ–°åˆ›å»ºçš„ ES7 ç´¢å¼•ã€‚è½¬åˆ°<em>mage2vuestorefront</em>ç›®å½•å’Œä¿®å¤<code>apiVersion</code>ä¸­<code>elasticsearch</code>çš„èŠ‚ç‚¹<code>config.js</code>ã€‚</li>
</ol>
<p>æºä»£ç /config.jsæ”¹å˜</p>
<table>
<thead>
<tr>
<th></th>
<th>@@ -61,7 +61,7 @@ module.exports = {</th>
</tr>
</thead>
<tbody>
<tr>
<td>6161</td>
<td>},</td>
</tr>
<tr>
<td>6262</td>
<td></td>
</tr>
<tr>
<td>6363</td>
<td>å¼¹æ€§æœç´¢ï¼š{</td>
</tr>
<tr>
<td>64</td>
<td>-     apiVersion: process.env.ELASTICSEARCH_API_VERSION || '<s>5</s>.<s>6</s>'</td>
</tr>
<tr>
<td>64</td>
<td>+     apiVersion: process.env.ELASTICSEARCH_API_VERSION || '7.1'</td>
</tr>
<tr>
<td>6565</td>
<td>},</td>
</tr>
<tr>
<td>6666</td>
<td></td>
</tr>
<tr>
<td>6767</td>
<td>Redisï¼š{</td>
</tr>
</tbody>
</table>
<p>æœ‰äº†è¿™ä¸ªå˜åŒ–<code>config.js</code>ï¼Œ<code>mage2vuestorefront</code>çŸ¥é“å¦‚ä½•å¤„ç†ä½ çš„<em>Elasticsearch</em>ç‰ˆæœ¬é«˜äº<code>6</code>.</p>
<ol>
<li>ç°åœ¨ä½¿ç”¨ shell æ•™æœºå™¨ä½ çš„é…ç½®<code>ENV</code>ï¼Œå¦‚ä¸‹ä¾‹ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">TIME_TO_EXIT</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAGENTO_CONSUMER_KEY</span><span class="token operator">=</span>lv1unkldzkcex68l3eojut4j66qqho8w
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAGENTO_CONSUMER_SECRET</span><span class="token operator">=</span>zhkuqvweo0bsg14noujqje49x3wht0qr
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAGENTO_ACCESS_TOKEN</span><span class="token operator">=</span>z6ftgc5005212bc6lnszxa7d7ocl8hgc
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAGENTO_ACCESS_TOKEN_SECRET</span><span class="token operator">=</span>h8tikjq9sz7tqm6hyhdfgs96krb6qzyk

<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAGENTO_URL</span><span class="token operator">=</span>http://local.magento/rest <span class="token comment"># Replace the url with your Magento 2 URL</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">INDEX_NAME</span><span class="token operator">=</span>vue_storefront_catalog <span class="token comment"># This will be the base name of the index we use</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>åœ¨ shell ä¸­é”®å…¥å®ƒä»¬ï¼Œç„¶åæ‚¨ä¼š<code>ENV</code>è®°ä½è¿™äº›å˜é‡ï¼Œç›´åˆ°ä¼šè¯è¿‡æœŸã€‚</p>
<p>æç¤º</p>
<p>å¦‚æœæ‚¨ä¸çŸ¥é“å¦‚ä½•è·å–è¿™äº›å‡­æ®ï¼Œè¯·æŸ¥çœ‹<a href="https://docs.vuestorefront.io/v1/guide/cookbook/data-import.html#_2-2-recipe-b-using-on-premise" target="_blank" rel="noopener noreferrer">æ•°æ®å¯¼å…¥<OutboundLink/></a></p>
<ol>
<li>è¿è¡Œæ‚¨çš„å·¥ä½œç¨‹åºä»¥å°†å…¶ä»æºç½‘ç»œå•†åº—æå–åˆ° Elasticsearch ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>node --harmony cli.js categories --removeNonExistent<span class="token operator">=</span>true
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>å±å¹•å°†æ˜¾ç¤ºå¦‚ä¸‹æ—¥å¿—ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2020</span>-01-07T07:21:00.959Z - debug: Elasticsearch module initialized<span class="token operator">!</span>
info: Winston logging library initialized.
<span class="token number">2020</span>-01-07T07:21:00.991Z - info: Connected correctly to server
<span class="token number">2020</span>-01-07T07:21:00.992Z - info: TRANSACTION KEY <span class="token operator">=</span> <span class="token number">1578381660987</span>
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories
debug: Response received.
Dest. <span class="token function">cat</span> path <span class="token operator">=</span>  default-category-2
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/2
debug: Response received.
Dest. <span class="token function">cat</span> path <span class="token operator">=</span>  default-category-2
<span class="token number">2020</span>-01-07T07:21:02.029Z - debug: Storing extended category data to cache under: vue_storefront_catalog_cat_2
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/4
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/5
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/3
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/7
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/8
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/9
debug: Calling API endpoint: GET http://franko.local/rest/V1/categories/6
debug: Response received.
Dest. <span class="token function">cat</span> path <span class="token operator">=</span>  boy/pants/pants-4
<span class="token number">2020</span>-01-07T07:21:03.427Z - info: Subcategory data extended <span class="token keyword">for</span> <span class="token number">2</span>, children object <span class="token number">4</span>
debug: Response received.
Dest. <span class="token function">cat</span> path <span class="token operator">=</span>  girl/pants/pants-9
<span class="token number">2020</span>-01-07T07:21:03.431Z - info: Subcategory data extended <span class="token keyword">for</span> <span class="token number">2</span>, children object <span class="token number">9</span>

<span class="token comment"># abridged ...</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>ğŸ“¼ä½ ä¹Ÿå¯ä»¥åœ¨<a href="https://asciinema.org/a/IViPWiFBkiE4of9L3ykncoPmU" target="_blank" rel="noopener noreferrer">bashæ’­æ”¾ä¸­<OutboundLink/></a>è§‚çœ‹<a href="https://asciinema.org/a/IViPWiFBkiE4of9L3ykncoPmU" target="_blank" rel="noopener noreferrer">ğŸ¥ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></p>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¡®è®¤æ‚¨åœ¨æ­£ç¡®çš„è·¯å¾„ä¸Šï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> -XGET <span class="token string">"http://localhost:9200/vue_storefront_catalog_category/_search?pretty=true"</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>å“åº”åº”å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token comment"># ... abridged</span>
      <span class="token punctuation">{</span>
        <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"vue_storefront_catalog_category"</span>,
        <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"8"</span>,
        <span class="token string">"_score"</span> <span class="token builtin class-name">:</span> <span class="token number">1.0</span>,
        <span class="token string">"_source"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"id"</span> <span class="token builtin class-name">:</span> <span class="token number">8</span>,
          <span class="token string">"parent_id"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,
          <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Outer"</span>,
          <span class="token string">"is_active"</span> <span class="token builtin class-name">:</span> true,
          <span class="token string">"position"</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
          <span class="token string">"level"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
          <span class="token string">"product_count"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
          <span class="token string">"children_data"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
          <span class="token string">"children"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,
          <span class="token string">"created_at"</span> <span class="token builtin class-name">:</span> <span class="token string">"2019-12-24 17:05:27"</span>,
          <span class="token string">"updated_at"</span> <span class="token builtin class-name">:</span> <span class="token string">"2019-12-24 17:05:27"</span>,
          <span class="token string">"path"</span> <span class="token builtin class-name">:</span> <span class="token string">"1/2/6/8"</span>,
          <span class="token string">"available_sort_by"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
          <span class="token string">"include_in_menu"</span> <span class="token builtin class-name">:</span> true,
          <span class="token string">"display_mode"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRODUCTS"</span>,
          <span class="token string">"is_anchor"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"children_count"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"custom_use_parent_settings"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"custom_apply_to_products"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"url_key"</span> <span class="token builtin class-name">:</span> <span class="token string">"outer-8"</span>,
          <span class="token string">"url_path"</span> <span class="token builtin class-name">:</span> <span class="token string">"girl/outer/outer-8"</span>,
          <span class="token string">"slug"</span> <span class="token builtin class-name">:</span> <span class="token string">"outer-8"</span>,
          <span class="token string">"tsk"</span> <span class="token builtin class-name">:</span> <span class="token number">1578381660987</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>
        <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"vue_storefront_catalog_category"</span>,
        <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"9"</span>,
        <span class="token string">"_score"</span> <span class="token builtin class-name">:</span> <span class="token number">1.0</span>,
        <span class="token string">"_source"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"id"</span> <span class="token builtin class-name">:</span> <span class="token number">9</span>,
          <span class="token string">"parent_id"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,
          <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Pants"</span>,
          <span class="token string">"is_active"</span> <span class="token builtin class-name">:</span> true,
          <span class="token string">"position"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
          <span class="token string">"level"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
          <span class="token string">"product_count"</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
          <span class="token string">"children_data"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
          <span class="token string">"children"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,
          <span class="token string">"created_at"</span> <span class="token builtin class-name">:</span> <span class="token string">"2019-12-24 17:05:52"</span>,
          <span class="token string">"updated_at"</span> <span class="token builtin class-name">:</span> <span class="token string">"2019-12-24 17:05:52"</span>,
          <span class="token string">"path"</span> <span class="token builtin class-name">:</span> <span class="token string">"1/2/6/9"</span>,
          <span class="token string">"available_sort_by"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
          <span class="token string">"include_in_menu"</span> <span class="token builtin class-name">:</span> true,
          <span class="token string">"display_mode"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRODUCTS"</span>,
          <span class="token string">"is_anchor"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"children_count"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"custom_use_parent_settings"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"custom_apply_to_products"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"url_key"</span> <span class="token builtin class-name">:</span> <span class="token string">"pants-9"</span>,
          <span class="token string">"url_path"</span> <span class="token builtin class-name">:</span> <span class="token string">"girl/pants/pants-9"</span>,
          <span class="token string">"slug"</span> <span class="token builtin class-name">:</span> <span class="token string">"pants-9"</span>,
          <span class="token string">"tsk"</span> <span class="token builtin class-name">:</span> <span class="token number">1578381660987</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>
        <span class="token string">"_index"</span> <span class="token builtin class-name">:</span> <span class="token string">"vue_storefront_catalog_category"</span>,
        <span class="token string">"_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
        <span class="token string">"_id"</span> <span class="token builtin class-name">:</span> <span class="token string">"7"</span>,
        <span class="token string">"_score"</span> <span class="token builtin class-name">:</span> <span class="token number">1.0</span>,
        <span class="token string">"_source"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"id"</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,
          <span class="token string">"parent_id"</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>,
          <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"Skirt"</span>,
          <span class="token string">"is_active"</span> <span class="token builtin class-name">:</span> true,
          <span class="token string">"position"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
          <span class="token string">"level"</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
          <span class="token string">"product_count"</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
          <span class="token string">"children_data"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
          <span class="token string">"children"</span> <span class="token builtin class-name">:</span> <span class="token string">""</span>,
          <span class="token string">"created_at"</span> <span class="token builtin class-name">:</span> <span class="token string">"2019-12-24 17:05:13"</span>,
          <span class="token string">"updated_at"</span> <span class="token builtin class-name">:</span> <span class="token string">"2019-12-24 17:26:22"</span>,
          <span class="token string">"path"</span> <span class="token builtin class-name">:</span> <span class="token string">"1/2/6/7"</span>,
          <span class="token string">"available_sort_by"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
          <span class="token string">"include_in_menu"</span> <span class="token builtin class-name">:</span> true,
          <span class="token string">"display_mode"</span> <span class="token builtin class-name">:</span> <span class="token string">"PRODUCTS"</span>,
          <span class="token string">"is_anchor"</span> <span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"children_count"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"custom_use_parent_settings"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"custom_apply_to_products"</span> <span class="token builtin class-name">:</span> <span class="token string">"0"</span>,
          <span class="token string">"url_key"</span> <span class="token builtin class-name">:</span> <span class="token string">"skirt-7"</span>,
          <span class="token string">"url_path"</span> <span class="token builtin class-name">:</span> <span class="token string">"girl/skirt/skirt-7"</span>,
          <span class="token string">"slug"</span> <span class="token builtin class-name">:</span> <span class="token string">"skirt-7"</span>,
          <span class="token string">"tsk"</span> <span class="token builtin class-name">:</span> <span class="token number">1578381660987</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><ol>
<li>é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°æ‚¨å®Œæˆå¯¼å…¥ä¹‹å‰æ˜ å°„åˆ°<em>Elasticsearch çš„</em>æ‰€æœ‰ç´¢å¼•çš„å®ä½“ï¼Œä¾‹å¦‚<em>äº§å“</em>ã€<em>å±æ€§</em>ã€<em>ç¨æ”¶è§„åˆ™</em>ç­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>node --harmony cli.js productcategories
node --harmony cli.js attributes --removeNonExistent<span class="token operator">=</span>true
node --harmony cli.js taxrule --removeNonExistent<span class="token operator">=</span>true
node --harmony cli.js products --removeNonExistent<span class="token operator">=</span>true --partitions<span class="token operator">=</span><span class="token number">1</span>
node --harmony cli.js reviews
node --harmony cli.js blocks
node --harmony cli.js pages
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ç¬”è®°</p>
<p>Magento çš„<em>è¯„è®º</em>ã€<em>å—</em>å’Œ<em>é¡µé¢çš„</em>API ç«¯ç‚¹ä¸æ˜¯å¼€ç®±å³ç”¨çš„ã€‚æ‚¨åº”è¯¥è‡ªå·±ä¸ºå®ƒä»¬å®‰è£…å…¶ä»–æ¨¡å—ã€‚<a href="https://github.com/divanteLtd/magento2-review-api" target="_blank" rel="noopener noreferrer">å®¡æŸ¥ ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a>,<a href="https://github.com/SnowdogApps/magento2-cms-api" target="_blank" rel="noopener noreferrer">å˜ç±³ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></p>
<p>ç°åœ¨æ‚¨å·²å‡†å¤‡å¥½å¯åŠ¨ç”±<em>Elasticsearch 7</em>æä¾›æ”¯æŒçš„ Vue Storefront å•†åº—ã€‚</p>
<ol>
<li>è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åœ¨<em>Vue Storefront</em>æ ¹è·¯å¾„å¯åŠ¨æ‚¨çš„å•†åº—ã€‚</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>docker-compose up 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>ä½ ä»¬ä¸€åˆ‡é¡ºåˆ©ï¼</p>
<h3 id="_3-çª¥è§†å¨æˆ¿-å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…" tabindex="-1"><a class="header-anchor" href="#_3-çª¥è§†å¨æˆ¿-å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_3-peep-into-the-kitchen-what-happens-internally" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>3.çª¥è§†å¨æˆ¿ï¼ˆå†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ï¼‰</h3>
<p><em>Elasticsearch</em>ç»å†äº†ä¸æ–­çš„å¯†é›†æ›´æ–°ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯å…·æœ‰å‘åå…¼å®¹æ€§çš„æ¸è¿›å¼æ›´æ”¹ï¼Œå› æ­¤å³ä½¿æ‚¨å°†å…¶å‡çº§åˆ°å¦ä¸€ä¸ªä¹Ÿä¸ä¼šæœ‰å¤ªå¤§å½±å“ã€‚ç„¶è€Œï¼Œè¿™ä¸€æ¬¡å‡çº§åˆ°<code>7.x</code>æœ‰ä¸€äº›é‡å¤§å˜åŒ–ï¼Œå…¶ä¸­ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>_type</code>ç´¢å¼•ä¸å…è®¸æœ‰å¤šä¸ªã€‚</p>
<p><em>Elasticsearch 7.x çš„</em>ä¿®å¤ä¸­æ–­å·²æˆåŠŸåŒ…å«åœ¨<em>Vue Storefront 1.11</em>å‡çº§ä¸­ã€‚</p>
<p>æ‚¨éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä½¿ç”¨<code>git</code>. å®¹å™¨çš„å‡çº§ç‰ˆæœ¬åœ¨<code>docker-compose</code>æ–‡ä»¶ä¸­è¿›è¡Œäº†æè¿°ï¼Œå› æ­¤å®ƒåŒ…å«çš„å†…å®¹è¢«å¾ˆå¥½åœ°å°è£…èµ·æ¥ï¼Œé™¤éæ‚¨æƒ³è°ƒæ•´è‡ªå®šä¹‰è€Œä¸æ˜¯é»˜è®¤è®¾ç½®ï¼Œå¦åˆ™æ‚¨ä¸å¿…æ‹…å¿ƒå®ƒåœ¨å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæ‚¨åº”è¯¥æ ¹æ®ç±»å‹ä¸º<em>Elasticsearch</em>ç´¢å¼•æ–°åˆ›å»ºæ¯ä¸ªæ˜ å°„ã€‚ç„¶åä½¿ç”¨<em>mage2vuestorefront</em>å°†æ‚¨çš„æ•°æ®æ³µå…¥<em>Elasticsearch</em>ã€‚</p>
<p>å¦‚æœåˆ°ç›®å‰ä¸ºæ­¢ä¸€åˆ‡æŒ‰è®¡åˆ’è¿›è¡Œé‚£ä¹ˆå¥½ï¼Œé‚£ä¹ˆæ‚¨çš„ 7-Elasticsearch åº”è¯¥ä½œä¸ºå…·æœ‰å¢å¼ºç´¢å¼•èƒ½åŠ›çš„æ•°æ®å­˜å‚¨çš„é«˜æ€§èƒ½æœç´¢å¼•æ“ã€‚</p>
<h3 id="_4-å¨å¸ˆçš„ç§˜å¯†-protip" tabindex="-1"><a class="header-anchor" href="#_4-å¨å¸ˆçš„ç§˜å¯†-protip" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_4-chef-s-secret-protip" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>4. å¨å¸ˆçš„ç§˜å¯† (protip)</h3>
<h4 id="ç§˜è¯€ä¸€ã€1-11æŠ€æœ¯ä¸Šå¦‚ä½•å‡çº§-ä¸‡æ— ä¸€å¤±çš„æ–¹æ³•ã€‚" tabindex="-1"><a class="header-anchor" href="#ç§˜è¯€ä¸€ã€1-11æŠ€æœ¯ä¸Šå¦‚ä½•å‡çº§-ä¸‡æ— ä¸€å¤±çš„æ–¹æ³•ã€‚" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#secret-1-how-to-upgrade-to-1-11-technically-foolproof-approach" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>ç§˜è¯€ä¸€ã€<code>1.11</code>æŠ€æœ¯ä¸Šå¦‚ä½•å‡çº§ï¼Ÿä¸‡æ— ä¸€å¤±çš„æ–¹æ³•ã€‚</h4>
<p>æœ‰ 3 ä¸ªå­˜å‚¨åº“åº”è¯¥å‡çº§ä¸º<code>1.11</code>.</p>
<p>æŸ¥çœ‹</p>
<p>è¯·ç¡®ä¿æ‚¨çš„ git ç©ºé—´æ˜¯å¹²å‡€çš„ï¼Œå¹¶ä¸”ä¸å³å°†è¿›è¡Œçš„åˆå¹¶æ²¡æœ‰ä»»ä½•å†²çªã€‚</p>
<p>é¦–å…ˆï¼Œè½¬åˆ°<em><strong>Vue Storefront API</strong></em>æ–‡ä»¶å¤¹å¹¶é”®å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">git</span> fetch
<span class="token function">git</span> merge v1.11.0
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ç¬”è®°</p>
<p>è¯·æ³¨æ„<code>v1.11.0</code>ï¼Œè¯¥<em>æ ‡ç­¾</em>è¡¨ç¤ºå½“å‰ç‰ˆæœ¬çš„æœ€ç»ˆæäº¤ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œè½¬åˆ°<em><strong>Vue Storefront</strong></em>æ–‡ä»¶å¤¹å¹¶é”®å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">git</span> fetch
<span class="token function">git</span> merge v1.11.0
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>æœ€åï¼Œè½¬åˆ°<em><strong>mage2vuestorefront</strong></em>æ–‡ä»¶å¤¹å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">git</span> fetch
<span class="token function">git</span> merge origin/feature/es7
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ç°åœ¨ä½ éƒ½å‡†å¤‡å¥½äº†ğŸ˜ƒ</p>
<h2 id="_2-ä¸º-vsf-æ‰©å±•-elasticsearch-å®ä½“" tabindex="-1"><a class="header-anchor" href="#_2-ä¸º-vsf-æ‰©å±•-elasticsearch-å®ä½“" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_2-extend-elasticsearch-entities-for-vsf" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>2. ä¸º VSF æ‰©å±• Elasticsearch å®ä½“</h2>
<p>ç½‘ä¸Šå•†åº—é€šå¸¸å…·æœ‰æŸäº›ç±»å‹çš„æ¨¡å‹å’Œåœºæ™¯ã€‚ï¼ˆå› ä¸ºå•†åº—å½’æ ¹ç»“åº•æ˜¯å•†åº—ï¼ä½ å¯¹å•†åº—æœ‰ä»€ä¹ˆæœŸæœ›ï¼ŸğŸ˜‰ï¼‰ä»–ä»¬ä¸ºç¤¾åŒºæ‰€ç†ŸçŸ¥ï¼Œå¤§å¤šæ•°ç”µå­å•†åŠ¡è½¯ä»¶å·²ç»æŒ‰ç…§é¢„æœŸå°†å®ƒä»¬å®ç°åˆ°ä»–ä»¬çš„æ¡†æ¶ä¸­ï¼Œè¿™å¯¹ä½ çš„æ–°ä¸šåŠ¡æœ‰å¥½å¤„ã€‚è¿™äº›è¡¨ç¤ºä¸ºå®ä½“ï¼Œå³<em>Catalog</em>ã€<em>Products</em>ã€<em>Attributes</em>ã€<em>Tax rule</em>ç­‰ã€‚ç”±äº<em>Vue Storefront</em>ä½œä¸ºé€šå¾€è¿™äº›ç”µå­å•†åŠ¡åç«¯çš„åä¸½é—¨æˆ·ï¼Œå®ƒè¿˜éœ€è¦å°½å¯èƒ½å¹³æ»‘åœ°åæ˜ è¿™äº›å®ä½“ã€‚</p>
<p>å¤§éƒ¨åˆ†ä¸»è¦å®ä½“å·²<code>core</code>æŒ‰é¢„æœŸåœ¨ VSF ä¸­å®ç°ï¼Œä½†æ‚¨å¯èƒ½ä»éœ€è¦æ·»åŠ æˆ–åˆ é™¤å…¶ä»–å®ä½“ï¼Œå› ä¸ºæ‚¨å¸Œæœ›å®ƒå®Œæˆæ‚¨çš„ä»»åŠ¡ã€‚è¿™ä¸ªé£Ÿè°±ä¼šè®©ä½ çŸ¥é“å¦‚ä½•å»åšã€‚</p>
<h3 id="_1-å‡†å¤‡-1" tabindex="-1"><a class="header-anchor" href="#_1-å‡†å¤‡-1" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_1-preparation-2" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>1. å‡†å¤‡</h3>
<ul>
<li>æ‚¨éœ€è¦<a href="https://docs.vuestorefront.io/v1/guide/cookbook/setup" target="_blank" rel="noopener noreferrer">è®¾ç½®<em>Vue Storefront</em>å †æ ˆï¼Œ<OutboundLink/></a>åŒ…æ‹¬<em>Vue Storefront API</em>ã€‚</li>
<li>æœ‰ä¸¤ç§æ–¹æ³•æ¥å¤„ç†<em>æœç´¢é€‚é…å™¨</em>çš„<em>å®ä½“ç±»å‹</em>; ä¸€ä¸ªæ˜¯<em>API</em>ï¼ˆæ–¹æ¡ˆ Aï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯<a href="https://graphql.org/" target="_blank" rel="noopener noreferrer"><em>GraphQL</em> ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a>ï¼ˆé…æ–¹Bï¼‰</li>
<li>æ‚¨åº”è¯¥åœ¨ Magento 2 ä¸­ä½¿ç”¨è‡ªå®šä¹‰å®ä½“æ¨¡å—æ¥å¯¼å…¥è‡ªå®šä¹‰å®ä½“ã€‚<a href="https://github.com/kkdg/Offline_Stores" target="_blank" rel="noopener noreferrer">åœ¨æ­¤å¤„<OutboundLink/></a>ä¸‹è½½ç¤ºä¾‹æ¨¡å—<a href="https://github.com/kkdg/Offline_Stores" target="_blank" rel="noopener noreferrer">ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></li>
<li>ä¸ºäº†æµ‹è¯•ï¼Œæ‚¨åº”è¯¥ä¸ºæ–°å®ä½“å¯¼å…¥æ•°æ®ã€‚<a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_2-0-appetizer" target="_blank" rel="noopener noreferrer">2-0ã€‚å¼€èƒƒèœä¼š<OutboundLink/></a>æŒ‡å¯¼æ‚¨å¦‚ä½•åšã€‚</li>
</ul>
<p>æç¤º</p>
<p>é»˜è®¤çš„<em>æœç´¢é€‚é…å™¨</em>æ˜¯<em>API</em>ã€‚</p>
<p>ä¸ºäº†æ”¹å˜å“ªä¸ª<em>Search Adapter</em>åº”è¯¥åœ¨workï¼Œè¯·çœ‹è¿™é‡Œ<a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#secret-1-how-to-switch-search-adapters" target="_blank" rel="noopener noreferrer">Chefçš„ç§˜è¯€1.å¦‚ä½•åˆ‡æ¢search adapters<OutboundLink/></a></p>
<h3 id="_2-0-å¼€èƒƒèœ" tabindex="-1"><a class="header-anchor" href="#_2-0-å¼€èƒƒèœ" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_2-0-appetizer" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>2-0 å¼€èƒƒèœ</h3>
<ol>
<li>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨éœ€è¦<em>åœ¨çº¿å•†åº—</em>çš„<em>ç¦»çº¿å•†åº—</em>çš„å®ä½“ç±»å‹ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†å•†åº—çš„ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®å­˜å‚¨ä¸­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯<em>Elasticsearchï¼Œ<em>åœ¨éœ€è¦æ—¶è¯»å–æ•°æ®ï¼Œå°±åƒæ‚¨æƒ³åœ¨ç»“è´¦æ—¶æ˜¾ç¤º</em>ç¦»çº¿å•†åº—ä¸€æ ·</em>ï¼Œå¦‚æœä»–ä»¬ä½åœ¨é™„è¿‘ï¼Œå®¢æˆ·å¯ä»¥é€‰æ‹©ã€‚</li>
</ol>
<p>ç¬”è®°</p>
<p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å°†æ•°æ®å¯¼å…¥æ•°æ®å­˜å‚¨ã€‚ä¸€ç”¨<a href="https://github.com/vuestorefront/mage2vuestorefront" target="_blank" rel="noopener noreferrer"><code>mage2vuestorefront</code> ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a>å®ƒè¿è¡Œ<em>NodeJS</em>è„šæœ¬æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè€Œå¦ä¸€ä¸ªç”¨äºä½¿ç”¨<a href="https://github.com/vuestorefront/magento2-vsbridge-indexer" target="_blank" rel="noopener noreferrer"><code>magento2-vsbridge-indexer</code> ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a>è¿™æ˜¯ç”¨äºè¯¥ä½œä¸šçš„æœ¬æœº Magento 2 æ¨¡å—ã€‚</p>
<p>åœ¨è¿™ä¸ªé£Ÿè°±ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©å‰è€…ã€‚ä¸è¿‡åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¹Ÿä¼šåœ¨<a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#secret-2-how-to-make-a-custom-import-using-magento2-vsbridge-indexer" target="_blank" rel="noopener noreferrer">å¨å¸ˆçš„ç§˜å¯† 2 ä¸­ç ”ç©¶<OutboundLink/></a>åè€…ã€‚</p>
<ol>
<li>è½¬åˆ°<em><strong>mage2vuestorefront</strong></em>æ ¹æ–‡ä»¶å¤¹å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> src/adapters/magento 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>è¯¥æ–‡ä»¶å¤¹æ˜¯è¿æ¥å™¨é€‚é…å™¨æ‰€åœ¨çš„ä½ç½®ã€‚</p>
<ol>
<li>åˆ›å»ºä»¥ä¸‹åä¸ºçš„æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œ<code>offline_stores.js</code>å¦‚ä¸‹ï¼š</li>
</ol>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> AbstractMagentoAdapter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./abstract'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CacheKeys <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cache_keys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">OfflineStoresAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMagentoAdapter</span> <span class="token punctuation">{</span>

 <span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token string">'offline_stores'</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token string">'adapters/magento/OfflineStoresAdapter'</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token function">getSourceData</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>api<span class="token punctuation">.</span>offlineStores<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**  Regarding Magento 2 api docs and reality we do have an exception here that items aren't listed straight in the response but under "items" key */</span>
 <span class="token function">prepareItems</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>items<span class="token punctuation">)</span>
     <span class="token keyword">return</span> items<span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>items<span class="token punctuation">.</span>total_count<span class="token punctuation">)</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>total_count <span class="token operator">=</span> items<span class="token punctuation">.</span>total_count<span class="token punctuation">;</span>
   
   <span class="token keyword">if</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
     items <span class="token operator">=</span> items<span class="token punctuation">.</span>items<span class="token punctuation">;</span> <span class="token comment">// this is an exceptional behavior for Magento 2 api  for attributes</span>

   <span class="token keyword">return</span> items<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token function">isFederated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token function">preProcessItem</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token punctuation">}</span>

     <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**
  * We're transforming the data structure of item to be compliant with Smile.fr Elastic Search Suite
  * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>object<span class="token punctuation">}</span></span> <span class="token parameter">item</span>  document to be updated in elastic search
  */</span>
 <span class="token function">normalizeDocumentFormat</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> item<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> OfflineStoresAdapter<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>è¿™æ˜¯é€‚é…å™¨çš„åŸºæœ¬æ¡†æ¶ã€‚æˆ‘ä»¬ç¨åä¼šçœ‹è¿™ä¸ªã€‚</p>
<ol>
<li>ç°åœ¨ï¼Œè½¬åˆ°<code>magento2-rest-client</code>library ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> magento2-rest-client/lib
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol>
<li>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦<code>offline_stores.js</code>ä½¿ç”¨ä»¥ä¸‹å†…å®¹ä¸ºé€‚é…å™¨åˆ›å»ºä¸€ä¸ªåº“æ–‡ä»¶ï¼š</li>
</ol>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">var</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">restClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

   module<span class="token punctuation">.</span><span class="token function-variable function">list</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">searchCriteria</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">var</span> endpointUrl <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'/offline-stores'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> restClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>endpointUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> module<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>æ­¤åº“æ–‡ä»¶ä»…å¤„ç†<em>GET</em> API ä»¥ä» Magento 2 è·å–ç¦»çº¿å•†åº—åˆ—è¡¨ã€‚</p>
<p>ç¬”è®°</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">var</span> endpointUrl <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'/offline-stores'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>è¿™ä¸€è¡Œç‰¹åˆ«é‡è¦ï¼Œå› ä¸º<code>'/offline-stores'</code>å®ƒæ˜¯ç¡®å®š API url ç«¯ç‚¹çš„åœ°æ–¹ã€‚å®ƒåº”è¯¥åŒ¹é… Magento 2 ç«¯çš„ API url ç«¯ç‚¹ã€‚</p>
<ol>
<li>ç°åœ¨æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªåº“åŒ…å«åœ¨<code>index.js</code>ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">vi</span> index.js
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ç„¶åæŒ‰å¦‚ä¸‹æ–¹å¼ä¿®å¤å®ƒï¼š</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token comment">// ... abridged </span>

<span class="token keyword">var</span> blocks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/blocks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pages <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/pages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> offlineStores <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/offline_stores'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">MAGENTO_API_VERSION</span> <span class="token operator">=</span> <span class="token string">'V1'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">Magento2Client</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

   options<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token constant">MAGENTO_API_VERSION</span><span class="token punctuation">;</span>

   <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">RestClient</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

   instance<span class="token punctuation">.</span>offlineStores <span class="token operator">=</span> <span class="token function">offlineStores</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
   instance<span class="token punctuation">.</span>attributes <span class="token operator">=</span> <span class="token function">attributes</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
   instance<span class="token punctuation">.</span>categories <span class="token operator">=</span> <span class="token function">categories</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// abridged ...</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol>
<li>åˆ›å»ºå‘½ä»¤å¯¼å…¥æ•°æ®çš„æ—¶é—´ï¼Œè½¬åˆ°<code>cli.js</code>æ‰€åœ¨æ–‡ä»¶å¤¹ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span> <span class="token comment"># ./src </span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>æ‰“å¼€<code>cli.js</code>å¹¶æ·»åŠ ä¸€ä¸ªæ–¹æ³•å’Œä¸€ä¸ªå‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token comment">// ... abridged </span>

<span class="token keyword">const</span> <span class="token function-variable function">reindexOfflineStores</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">adapterName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> adapter <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span>adapterName<span class="token punctuation">,</span> <span class="token string">'offline_stores'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   adapter<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     <span class="token function-variable function">done_callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
       logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'Task done! Exiting in 30s...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">setTimeout</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>exit<span class="token punctuation">,</span> <span class="token constant">TIME_TO_EXIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// let ES commit all changes made</span>
       <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

program
 <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'offlinestores'</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--adapter &lt;adapter>'</span><span class="token punctuation">,</span> <span class="token string">'name of the adapter'</span><span class="token punctuation">,</span> <span class="token string">'magento'</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--removeNonExistent &lt;removeNonExistent>'</span><span class="token punctuation">,</span> <span class="token string">'remove non existent products'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
   <span class="token keyword">await</span> <span class="token function">reindexOfflineStores</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>adapter<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>removeNonExistent<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

program
 <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'attributes'</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--adapter &lt;adapter>'</span><span class="token punctuation">,</span> <span class="token string">'name of the adapter'</span><span class="token punctuation">,</span> <span class="token string">'magento'</span><span class="token punctuation">)</span>
<span class="token comment">// abridged...</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ol>
<li>ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œç°åœ¨è¿è¡Œå‘½ä»¤å¯¼å…¥ç¦»çº¿å•†åº—ä¿¡æ¯ï¼</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code>node cli.js offlinestores
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>æ‚¨å°†çœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„å±å¹•ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token number">2020</span>-03-10T09:22:30.359Z - debug: Elasticsearch module initialized<span class="token operator">!</span>
info: Winston logging library initialized.
<span class="token number">2020</span>-03-10T09:22:30.796Z - info: Connected correctly to server
<span class="token number">2020</span>-03-10T09:22:30.796Z - info: TRANSACTION KEY <span class="token operator">=</span> <span class="token number">1583832150786</span>
debug: Calling API endpoint: GET http://localhost/rest//V1/offline-stores
debug: Response received.
<span class="token number">2020</span>-03-10T09:22:32.130Z - info: Importing <span class="token number">0</span> of <span class="token number">3</span> - <span class="token number">1</span> with tsk <span class="token operator">=</span> <span class="token number">1583832150786</span>
<span class="token number">2020</span>-03-10T09:22:32.131Z - info: Tasks count <span class="token operator">=</span> <span class="token number">2</span>
<span class="token number">2020</span>-03-10T09:22:32.139Z - info: Importing <span class="token number">1</span> of <span class="token number">3</span> - <span class="token number">2</span> with tsk <span class="token operator">=</span> <span class="token number">1583832150786</span>
<span class="token number">2020</span>-03-10T09:22:32.139Z - info: Tasks count <span class="token operator">=</span> <span class="token number">1</span>
<span class="token number">2020</span>-03-10T09:22:32.139Z - info: Importing <span class="token number">2</span> of <span class="token number">3</span> - <span class="token number">3</span> with tsk <span class="token operator">=</span> <span class="token number">1583832150786</span>
<span class="token number">2020</span>-03-10T09:22:32.140Z - info: Tasks count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">2020</span>-03-10T09:22:32.140Z - info: No tasks to process. All records processed<span class="token operator">!</span>
<span class="token number">2020</span>-03-10T09:22:32.140Z - info: Task done<span class="token operator">!</span> Exiting <span class="token keyword">in</span> 30s<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>ç¬”è®°</p>
<p>åœ¨è¿è¡Œå‘½ä»¤ä¹‹å‰ï¼Œæ‚¨åº”è¯¥åƒè¿™æ ·å‘Šè¯‰æœºå™¨ç¯å¢ƒå˜é‡ï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">MAGENTO_URL</span><span class="token operator">=</span>http://localhost/rest
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>å¦‚æœæ‚¨ä¸º Magento 2 å®ä¾‹ä½¿ç”¨ä¸åŒçš„ç½‘å€ï¼Œè¯·æ›´æ¢ç½‘å€ã€‚</p>
<ol>
<li>è®©æˆ‘ä»¬ç¡®è®¤ç»“æœå¹¶ç»“æŸå®ƒï¼</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">curl</span> localhost:8080/api/catalog/vue_storefront_catalog/offline_stores/_search
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>é™¤éæœ‰é—®é¢˜ï¼Œå¦åˆ™å“åº”åº”å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">"took"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
  <span class="token string">"timed_out"</span><span class="token builtin class-name">:</span> false,
  <span class="token string">"_shards"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"total"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">"successful"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">"skipped"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
    <span class="token string">"failed"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"hits"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"total"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
      <span class="token string">"relation"</span><span class="token builtin class-name">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"max_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">"hits"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"vue_storefront_catalog_offline_stores"</span>,
        <span class="token string">"_type"</span><span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
        <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"2"</span>,
        <span class="token string">"_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"2"</span>,
          <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"Wrocaw"</span>,
          <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token string">"Ulica Romana Dmowskiego 17, 50-203 Wrocaw, Poland"</span>,
          <span class="token string">"phone"</span><span class="token builtin class-name">:</span> <span class="token string">"+48 577 032 500"</span>,
          <span class="token string">"is_active"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"tsk"</span><span class="token builtin class-name">:</span> <span class="token number">1583832150786</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>
        <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"vue_storefront_catalog_offline_stores"</span>,
        <span class="token string">"_type"</span><span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
        <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"3"</span>,
        <span class="token string">"_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"3"</span>,
          <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"Seoul"</span>,
          <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token string">"Seoul GangNam Street 1st 12"</span>,
          <span class="token string">"phone"</span><span class="token builtin class-name">:</span> <span class="token string">"+82 10 2364 3330"</span>,
          <span class="token string">"is_active"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"tsk"</span><span class="token builtin class-name">:</span> <span class="token number">1583832150786</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>,
      <span class="token punctuation">{</span>
        <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"vue_storefront_catalog_offline_stores"</span>,
        <span class="token string">"_type"</span><span class="token builtin class-name">:</span> <span class="token string">"_doc"</span>,
        <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
        <span class="token string">"_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"Warszawa"</span>,
          <span class="token string">"address"</span><span class="token builtin class-name">:</span> <span class="token string">"Koci pw. w. Michaa Archanioa"</span>,
          <span class="token string">"phone"</span><span class="token builtin class-name">:</span> <span class="token string">"+48 22 845 46 04"</span>,
          <span class="token string">"is_active"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
          <span class="token string">"tsk"</span><span class="token builtin class-name">:</span> <span class="token number">1583832150786</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>æ‚¨å·²æˆåŠŸå¯¼å…¥è‡ªå®šä¹‰å®ä½“ï¼</p>
<h3 id="_2-1ã€‚é…æ–¹-a-å¸¦-api" tabindex="-1"><a class="header-anchor" href="#_2-1ã€‚é…æ–¹-a-å¸¦-api" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_2-1-recipe-a-with-api" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>2-1ã€‚é…æ–¹ Aï¼ˆå¸¦ APIï¼‰</h3>
<ol>
<li>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸‹é¢åˆ›å»ºä¸€ä¸ª<code>api</code>æ–‡ä»¶å¤¹<code>src/search/adapter/</code>ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token builtin class-name">cd</span> src/search/adapter
<span class="token function">mkdir</span> api 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol>
<li><code>searchAdapter</code>ä»<code>core</code>æ–‡ä»¶å¤¹å¤åˆ¶æ–‡ä»¶ï¼š</li>
</ol>
<div class="language-bash ext-sh line-numbers-mode"><pre v-pre class="language-bash"><code><span class="token function">cp</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/core/lib/search/adapter/api/searchAdapter.ts api/
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>ç¬”è®°</p>
<p>æ‚¨åº”è¯¥å¤åˆ¶æ•´ä¸ª<code>searchAdapter.ts</code>æ–‡ä»¶çš„åŸå› æ˜¯ï¼Œè¿™æ ·åšæ—¶æ‚¨çš„é€‚é…å™¨è¿˜å°†é»˜è®¤å®ä½“åŒ…å«<code>core</code>åˆ°è‡ªå®šä¹‰æ–‡ä»¶ä¸­ï¼Œå› ä¸ºæ‚¨çš„è‡ªå®šä¹‰å®ä½“æ— æ³•å¢é‡æ·»åŠ åˆ°é»˜è®¤å€¼ä¸­ã€‚è¿™å°±æ˜¯<a href="https://github.com/vuestorefront/vue-storefront/blob/master/core/lib/search/adapter/searchAdapterFactory.js#L12-L20" target="_blank" rel="noopener noreferrer">ä¸ºä»€ä¹ˆï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a></p>
<ol>
<li>ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥å¤„ç†<code>searchAdapter.ts</code>åˆšåˆšå¤åˆ¶çš„è‡ªå®šä¹‰å®ä½“ç±»å‹çš„æ·»åŠ ï¼Œå¹¶åœ¨åŒä¸€ä¸ªç±»çš„<em>æ„é€ </em>å‡½æ•°ä¸­å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ol>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token comment">// ... abridged</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SearchAdapter</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span> entities<span class="token operator">:</span> any

 <span class="token keyword">public</span> <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>entities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initBaseTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initCustomTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//... abridged ...</span>

 <span class="token keyword">public</span> <span class="token function">initCustomTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerEntityType</span><span class="token punctuation">(</span><span class="token string">'offline_stores'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
     <span class="token function-variable function">queryProcessor</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">query</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
       <span class="token comment">// function that can modify the query each time before it's being executed</span>
       <span class="token keyword">return</span> query
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token function-variable function">resultProcessor</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">resp<span class="token punctuation">,</span> start<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleResult</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> <span class="token string">'offline_stores'</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>åœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ä»¥<code>registerEntityType</code>æ–¹æ³•æ·»åŠ <code>offline_stores</code>å®ä½“ç±»å‹ä¸ºä¾‹ã€‚</p>
<p>å¦‚æœæ‚¨æƒ³æ·»åŠ æ›´å¤šå®ä½“ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦å¤šæ¬¡å…‹éš†è¯¥ç¤ºä¾‹å¹¶æ ¹æ®éœ€è¦æ›´æ”¹å®ä½“åç§°ã€‚</p>
<p>æç¤º</p>
<p><code>initCustomTypes</code>ä¸Šé¢çš„æ–¹æ³•æ˜¯éšæ„å‘½åçš„ï¼Œå› æ­¤æ‚¨å®é™…ä¸Šå¯ä»¥ä¸ºè¯¥æ–¹æ³•ä½¿ç”¨ä»»ä½•å…¶ä»–åç§°ã€‚</p>
<p>ç°åœ¨æ‚¨å·²å‡†å¤‡å¥½ä½¿ç”¨æ‚¨åˆšåˆšåˆ›å»ºçš„è‡ªå®šä¹‰å®ä½“ã€‚ä¸‹ä¸€æ­¥è®©æ‚¨å¯¹å¦‚ä½•ç¡®è®¤æœ‰ä¸€ä¸ªç®€å•çš„æƒ³æ³•ã€‚ï¼ˆå¯é€‰çš„ï¼‰</p>
<ol>
<li>å‰å¾€<code>src/modules/instant-checkout/components</code>å¹¶æ‰“å¼€<code>InstantCheckout.vue</code>ã€‚ä¿®å¤å¦‚ä¸‹ï¼š</li>
</ol>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token comment">// ... abridged </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> currentStoreView <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue-storefront/core/lib/multistore'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> registerModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue-storefront/core/lib/modules'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> OrderModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue-storefront/core/modules/order'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> quickSearchByQuery <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue-storefront/core/lib/search'</span><span class="token punctuation">;</span> <span class="token comment">// Import the method to fetch data from ES</span>

<span class="token keyword">const</span> storeView <span class="token operator">=</span> <span class="token function">currentStoreView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// ... abridged</span>

 methods<span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token keyword">async</span> <span class="token function">showPayment</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// the method should be done with async/await</span>
     <span class="token keyword">let</span> offlineStores <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">quickSearchByQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entityType<span class="token operator">:</span> <span class="token string">'offline_stores'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Your item will be sent from the shop at "</span> <span class="token operator">+</span> offlineStores<span class="token punctuation">.</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token keyword">const</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>paymentMethods<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paymentDetails <span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paymentOptions<span class="token punctuation">)</span>

     <span class="token comment">// abridged ...</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>ç°åœ¨å»æ‚¨çš„ç½‘ä¸Šå•†åº—ï¼Œå°†å•†å“æ”¾å…¥è´­ç‰©è½¦å¹¶æ‰“å¼€å®ƒï¼Œå•å‡»â€œ**å³æ—¶ç»“è´¦â€**æŒ‰é’®ï¼Œç„¶åæ‚¨å°†çœ‹åˆ°å¦‚ä¸‹å±å¹•ï¼š</p>
<p><img src="https://docs.vuestorefront.io/v1/assets/img/stores.79c55657.png" alt="Instant_checkout_store_borderline"></p>
<h3 id="_3-çª¥è§†å¨æˆ¿-å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…-1" tabindex="-1"><a class="header-anchor" href="#_3-çª¥è§†å¨æˆ¿-å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…-1" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_3-peep-into-the-kitchen-what-happens-internally-2" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>3.çª¥è§†å¨æˆ¿ï¼ˆå†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ï¼‰</h3>
<p>åœ¨è¿™ä¸ªç§˜ç±ä¸­ï¼Œæˆ‘ä»¬è¿­ä»£äº†åœ¨æ‚¨çš„åœ¨çº¿å•†åº—ï¼ˆè¿™æ¬¡æ˜¯ Magento 2ï¼‰ä¸Šæ„å»ºè‡ªå®šä¹‰å®ä½“çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ— è®ºå‡ºäºä½•ç§åŸå› å¤„ç†å„ç§ä¿¡æ¯ä»¥å¢å¼ºæ‚¨çš„å®¢æˆ·ä½“éªŒã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸º<em>ç¦»çº¿å•†åº—</em>å®ä½“ä¸‹è½½äº†ä¸€ä¸ª Magento 2 æ¨¡å—ã€‚å®ƒåŒ…å«æ¯ä¸ªçº¿ä¸‹å•†åº—çš„åŸºæœ¬ä¿¡æ¯ã€‚</p>
<p>å…¶æ¬¡ï¼Œä½œä¸ºå¼€èƒƒèœï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<em>mage2vuestorefront</em>ä»å•†åº—å¯¼å…¥æ•°æ®ã€‚æˆ‘ä»¬è·Ÿéšæ ¸å¿ƒå›¢é˜Ÿå¦‚ä½•ä½¿ç”¨å…¶å…„å¼Ÿå¼€æºæ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œä¸»èœï¼Œæˆ‘ä»¬åœ¨<code>src</code>æ–‡ä»¶å¤¹ä¸­æ‰©å±•äº†æ ¸å¿ƒé€‚é…å™¨ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è¿›è¡Œæœªæ¥æ›´æ–°ğŸ˜ƒã€‚å…¶å®å¾ˆç®€å•ï¼æ‚¨åªéœ€è¦<code>registerEntityType</code>ä¸ºæ‚¨çš„è‡ªå®šä¹‰å®ä½“ï¼æˆ‘ä»¬è¿˜ç ”ç©¶äº†å¦‚ä½•åœ¨å®é™…ç¤ºä¾‹ä¸­å®ç°å®ƒï¼Œå°½ç®¡å®ƒæ˜¯ç®€åŒ–ç‰ˆæœ¬ï¼Œæ‚¨æœ€å¥½éµå¾ª<code>vuex</code>æœ€ä½³å®è·µã€‚</p>
<p>æˆ‘ä»¬è¿˜æœ‰å„ç§ä¸»èœï¼Œä¸ºæ‚¨æä¾›ä½¿ç”¨<em>GraphQL</em>çš„é€‰é¡¹ã€‚è¿™ç§æ–¹æ³•éœ€è¦æˆ‘ä»¬è¿›è¡Œæ›´å¤šçš„è°ƒæ•´ï¼Œä½†ç›¸ä¿¡æˆ‘ï¼Œ<em>GraphQL</em>æœ‰<a href="https://www.altexsoft.com/blog/engineering/graphql-core-features-architecture-pros-and-cons/" target="_blank" rel="noopener noreferrer">å¾ˆå¥½çš„ä¼˜åŠ¿ ï¼ˆæ‰“å¼€æ–°çª—å£ï¼‰<OutboundLink/></a>è¶…è¿‡å…¶ç«äº‰å¯¹æ‰‹ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°½å¯èƒ½åœ°æ‰©å±•æˆ‘ä»¬çš„å•†åº—ï¼Œä»¥å¤„ç†æ›´å¤šå…³äºæ‚¨å•†åº—çš„ä¿¡æ¯ã€‚æ­å–œï¼</p>
<h3 id="_4-å¨å¸ˆçš„ç§˜å¯†-protip-1" tabindex="-1"><a class="header-anchor" href="#_4-å¨å¸ˆçš„ç§˜å¯†-protip-1" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#_4-chef-s-secret-protip-2" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>4. å¨å¸ˆçš„ç§˜å¯† (protip)</h3>
<h4 id="ç§˜å¯†-1-å¦‚ä½•åˆ‡æ¢æœç´¢é€‚é…å™¨" tabindex="-1"><a class="header-anchor" href="#ç§˜å¯†-1-å¦‚ä½•åˆ‡æ¢æœç´¢é€‚é…å™¨" aria-hidden="true">#</a> <a href="https://docs.vuestorefront.io/v1/guide/cookbook/elastic.html#secret-1-how-to-switch-search-adapters" target="_blank" rel="noopener noreferrer">#<OutboundLink/></a>ç§˜å¯† 1. å¦‚ä½•åˆ‡æ¢<em>æœç´¢é€‚é…å™¨</em></h4>
<p>å¦‚æœè¦ä½¿ç”¨<em>GraphQL</em>é€‚é…å™¨è¿›è¡Œæœç´¢ï¼Œåˆ™éœ€è¦å°†<em>Vue Storefront ä¸­</em><code>server.api</code>nodeçš„å€¼æ›´æ”¹ä¸º<code>graphql</code>in <code>./config/local.json</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">"server"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
    <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
    <span class="token property">"protocol"</span><span class="token operator">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
    <span class="token property">"api"</span><span class="token operator">:</span> <span class="token string">"graphql"</span><span class="token punctuation">,</span>
    <span class="token property">"devServiceWorker"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"useHtmlMinifier"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"htmlMinifierOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></template>
